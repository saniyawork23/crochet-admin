<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crochet Admin ‚Äì View Orders</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    /* ================= NAVBAR ================= */
    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 30px;
      background: #ffffff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      font-family: 'Poppins', sans-serif;
    }

    .nav-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-icon { font-size: 22px; }
    .brand-name {
      font-size: 18px;
      font-weight: 600;
      color: #4f46e5;
    }

    .nav-links a {
      margin-left: 20px;
      text-decoration: none;
      font-size: 14px;
      color: #444;
      font-weight: 500;
    }

    .nav-links a:hover { color: #4f46e5; }

    /* ================= PAGE ================= */
    .orders-page {
      font-family: 'Poppins', sans-serif;
      background: #f5f7fb;
      min-height: calc(100vh - 64px);
      padding: 30px;
    }

    .orders-container {
      max-width: 1150px;
      margin: auto;
      background: #ffffff;
      padding: 25px;
      border-radius: 14px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
    }

    .orders-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: #f0f1ff;
      padding: 12px;
      font-size: 13px;
      color: #4f46e5;
      text-align: left;
    }

    td {
      padding: 12px;
      font-size: 13px;
      border-bottom: 1px solid #eee;
      color: #444;
      vertical-align: top;
    }

    tr:hover { background: #fafafa; }

    .view-btn {
      background: #e0e7ff;
      color: #3730a3;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
    }

    .edit-btn {
      background: #4f46e5;
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      margin-right: 6px;
    }

    .delete-btn {
      background: #ef4444;
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }

    .items-row {
      display: none;
      background: #fafafa;
    }

    .items-box {
      padding: 15px 25px;
    }

    .items-box table {
      width: 100%;
      border-collapse: collapse;
    }

    .items-box th {
      background: #f8fafc;
      color: #555;
      font-size: 12px;
    }

    .items-box td {
      font-size: 12px;
    }
  </style>
</head>

<body>

<!-- ================= NAVBAR ================= -->
<div class="navbar">
  <div class="nav-left">
    <div class="brand-icon">üß∂</div>
    <div class="brand-name">Crochet Admin</div>
  </div>

  <div class="nav-links">
    <a href="index.html">Add Order</a>
    <a href="orders.html">View Orders</a>
    <a href="customers.html">Customers</a>
    <a href="dashboard.html">Dashboard</a>
  </div>
</div>

<!-- ================= ORDERS PAGE ================= -->
<div class="orders-page">
  <div class="orders-container">

    <div class="orders-header">
      <h2>Orders</h2>
    </div>

    <table id="ordersTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Total (‚Çπ)</th>
          <th>Payment</th>
          <th>Items</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

  </div>
</div>

<script>
const API_KEY = "AIzaSyBOYSx1ViWXNl8OJG0s1aQDjGJm6A8r9dE";
const SPREADSHEET_ID = "10Z1De-hhJkihZsncW15xlz-VihhGodcWP1eGWWJ7bNU";

const ORDERS_RANGE = "Orders!A2:Z";
const ITEMS_RANGE  = "Order Items!A2:E";

async function fetchSheet(range) {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?key=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();
  return data.values || [];
}

async function fetchOrders() {
  const ordersData = await fetchSheet(ORDERS_RANGE);
  const itemsData  = await fetchSheet(ITEMS_RANGE);

  /* ---------- Map Order Items by OrderID ---------- */
  const itemsMap = {};
  itemsData.forEach(row => {
    const [orderId, item, qty, price] = row;
    if (!itemsMap[orderId]) itemsMap[orderId] = [];
    itemsMap[orderId].push({
      item,
      qty: Number(qty),
      price: Number(price)
    });
  });

  const tbody = document.querySelector("#ordersTable tbody");
  tbody.innerHTML = "";

  ordersData.forEach((row, index) => {
    const [
      orderId,
      customerId,
      customerName,
      contact,
      date,
      mode,
      total
    ] = row;

    const items = itemsMap[orderId] || [];

    /* -------- Main Order Row -------- */
    const mainRow = document.createElement("tr");
    mainRow.innerHTML = `
      <td>${date || ""}</td>
      <td>${orderId}</td>
      <td>${customerName}</td>
      <td>‚Çπ${total}</td>
      <td>${mode}</td>
      <td>
        <button class="view-btn" onclick="toggleItems(${index})">
          View Items (${items.length})
        </button>
      </td>
      <td>
        <button class="edit-btn" onclick="editOrder('${orderId}')">Edit</button>
        <button class="delete-btn" onclick="deleteOrder('${orderId}')">Delete</button>
      </td>
    `;

    /* -------- Expandable Items Row -------- */
    const itemsRow = document.createElement("tr");
    itemsRow.className = "items-row";
    itemsRow.id = `items-${index}`;
    itemsRow.innerHTML = `
      <td colspan="7">
        <div class="items-box">
          <table>
            <thead>
              <tr>
                <th>Item</th>
                <th>Qty</th>
                <th>Price (‚Çπ)</th>
                <th>Total (‚Çπ)</th>
              </tr>
            </thead>
            <tbody>
              ${
                items.length === 0
                  ? `<tr><td colspan="4">No items</td></tr>`
                  : items.map(it => `
                    <tr>
                      <td>${it.item}</td>
                      <td>${it.qty}</td>
                      <td>${it.price}</td>
                      <td>${it.qty * it.price}</td>
                    </tr>
                  `).join("")
              }
            </tbody>
          </table>
        </div>
      </td>
    `;

    tbody.appendChild(mainRow);
    tbody.appendChild(itemsRow);
  });
}

function toggleItems(index) {
  const row = document.getElementById(`items-${index}`);
  row.style.display = row.style.display === "table-row" ? "none" : "table-row";
}

function editOrder(orderId) {
  alert("Edit logic next phase üöß\nOrder ID: " + orderId);
}

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyE1ugRiqJDlLQv5be17rHyewTNOk6XPDoyowMIE1dRmgkXO-Eto1TH3eZmqSI5P-wY/exec";
async function deleteOrder(orderId) {
  if (!confirm("Delete this order permanently?")) return;

  try {
    const res = await fetch(
      `${SCRIPT_URL}?action=deleteOrder&orderId=${encodeURIComponent(orderId)}`
    );

    const text = await res.text();

    if (text.toLowerCase().includes("error")) {
      alert("‚ùå " + text);
    } else {
      alert("‚úÖ " + text);
      fetchOrders(); // refresh
    }

  } catch (err) {
    console.error(err);
    alert("‚ùå Delete failed. Check console.");
  }
}



window.addEventListener("DOMContentLoaded", fetchOrders);
</script>

</body>
</html>









