<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Order</title>
<style>
body { font-family: 'Poppins', sans-serif; background: #f5f7fb; padding: 20px; }
.container { max-width: 500px; margin: auto; background: #fff; padding: 25px; border-radius: 14px; box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
h2 { text-align: center; margin-bottom: 20px; color:#333; }
.form-group { margin-bottom: 15px; display:flex; flex-direction: column; }
label { margin-bottom: 5px; font-weight: 500; }
input, select { padding: 8px; border-radius: 6px; border:1px solid #ccc; }
.item-row { display: grid; grid-template-columns: 2fr 1fr 1fr; gap:10px; margin-bottom:10px; }
.item-row input { padding:6px; border-radius:6px; border:1px solid #ddd; }
.add-item-btn { background: transparent; border:1px dashed #8b5cf6; color:#8b5cf6; padding:8px; border-radius:6px; cursor:pointer; margin-bottom:15px; }
.btn-primary { width:100%; padding:10px; background: linear-gradient(135deg,#8b5cf6,#6366f1); border:none; border-radius:10px; color:#fff; cursor:pointer; }
.btn-primary:hover { opacity:0.95; }
</style>
</head>
<body>

<div class="container">
  <h2>Edit Order</h2>
  <form id="editOrderForm">

    <div class="form-group">
      <label>Customer Name</label>
      <input type="text" id="customerName" required>
    </div>

    <div class="form-group">
      <label>Contact Number</label>
      <input type="tel" id="contact">
    </div>

    <h3 style="margin:10px 0; color:#4f46e5;">Items Purchased</h3>
    <div id="itemsContainer"></div>
    <button type="button" class="add-item-btn" onclick="addItemRow()">+ Add Item</button>

    <div class="form-group">
      <label>Total Order Amount</label>
      <input type="number" id="total" readonly>
    </div>

    <div class="form-group">
      <label>Date of Purchase</label>
      <input type="date" id="date" required>
    </div>

    <div class="form-group">
      <label>Purchase Mode</label>
      <select id="mode" required>
        <option value="">Select</option>
        <option>Offline</option>
        <option>Online</option>
      </select>
    </div>

    <button type="submit" class="btn-primary">Save Changes</button>
  </form>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const orderId = urlParams.get('orderId');
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbywdyecRtrIwdBwDmiwvcZV8kCSS0w4mBd5DmiWxXDqh5b6JlC95_s_xktiq0RWwni9/exec";

const itemsContainer = document.getElementById('itemsContainer');

function addItemRow(name='', qty='', price='') {
  const row = document.createElement('div');
  row.className = 'item-row';
  row.innerHTML = `
    <input type="text" placeholder="Item Name" class="item-name" required value="${name}">
    <input type="number" placeholder="Qty" class="item-qty" min="1" required value="${qty}">
    <input type="number" placeholder="Price" class="item-price" min="0" required value="${price}">
    <button type="button" onclick="this.closest('.item-row').remove(); updateTotal()" style="color:#dc3545; background:none; border:none; cursor:pointer;">✖</button>
  `;
  itemsContainer.appendChild(row);
  updateTotal();
}

function updateTotal() {
  let total = 0;
  document.querySelectorAll('#itemsContainer .item-row').forEach(row => {
    const qty = Number(row.querySelector('.item-qty').value) || 0;
    const price = Number(row.querySelector('.item-price').value) || 0;
    total += qty * price;
  });
  document.getElementById('total').value = total;
}

// Recalculate total when item changes
itemsContainer.addEventListener('input', updateTotal);

// Fetch order details
async function loadOrder() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=getOrderById&orderId=${orderId}`);
    const order = await res.json();

    document.getElementById('customerName').value = order.customerName;
    document.getElementById('contact').value = order.contact;
    document.getElementById('date').value = order.date;
    document.getElementById('mode').value = order.purchaseMode;

    itemsContainer.innerHTML = '';
    order.items.forEach(item => addItemRow(item.name, item.qty, item.price));
    updateTotal();
  } catch (err) {
    alert('Failed to load order: ' + err.message);
  }
}

// Handle form submit
document.getElementById('editOrderForm').addEventListener('submit', async e => {
  e.preventDefault();
  const items = Array.from(document.querySelectorAll('#itemsContainer .item-row')).map(row => ({
    name: row.querySelector('.item-name').value,
    qty: Number(row.querySelector('.item-qty').value),
    price: Number(row.querySelector('.item-price').value)
  }));

  const params = new URLSearchParams({
    action: 'updateOrder',
    orderId: orderId,
    customerName: document.getElementById('customerName').value,
    contact: document.getElementById('contact').value,
    date: document.getElementById('date').value,
    purchaseMode: document.getElementById('mode').value,
    total: document.getElementById('total').value,
    items: JSON.stringify(items)
  });

  try {
    await fetch(`${SCRIPT_URL}?${params.toString()}`, { method: 'GET', mode: 'no-cors' });
    alert('✅ Order updated successfully!');
    window.location.href = 'orders.html';
  } catch (err) {
    alert('❌ Failed to update order: ' + err.message);
  }
});

loadOrder();
</script>

</body>
</html>
